%----------------------------------------------------------------------------
\section{MATLAB prototípus}
%----------------------------------------------------------------------------
	A MATLAB a Mathworks által fejlesztett és karbantartott programrendszer, mely a MATLAB programozási nyelv köré épül. Közkedvelt, széleskörû lehetõségeket biztosít elsõsorban numerikus számítások és mátrixmûveletek elvégzésére. Rengeteg beépített függvény és függvénycsomag mellett található egy grafikus, blokkokból építkezõ modellezést és szimulációt elõsegítõ környezet is, a Simulink. Elterjedten használják jel- és adatfeldolgozásra, szabályozótervezésre, komplex rendszerek (például szélturbina) szimulálására.
	
	Elsõ körben a gyors megvalósíthatóság (prototípustervezés) és a rengeteg beépített ábrázolási lehetõség miatt választottam a MATLAB-ot. Már fejlesztés közben könnyen észrevehetõvé válnak a hibák.

	Szkriptnyelvrõl lévén szó, ebben az alkalmazásban nem a teljesítmény volt a mérvadó, hanem, hogy megismerkedjek a problémával és lássam, mire kell odafigyelni a késõbbi megvalósítások során.

	Érdemes megemlíteni, hogy léteznek MATLAB számára is párhuzamosítási lehetõségek, programcsomagok melyek a számításintenzív adatfeldolgozást hivatottak gyorsítani. Ilyen a Parallel Computing Toolbox, mely magasszintû hozzáférést biztosít a számítógép erõforrásaihoz, segítve a gyors fejlesztést. Ezzel azonban a diplomamunkám során nem foglalkoztam.

	A soron következõ alfejezetekben bemutatom a MATLAB-ban készített programom felépítését.

	%----------------------------------------------------------------------------
	\subsection{Main}
	%----------------------------------------------------------------------------
		Az alkalmazás egy \verb+Main+ nevezetû script futtatásával indul el. A script legelején vannak a változók, melyek beállításával változtathatók a szimuláció paraméterei. Ezek szerepenek a \tabref{mat_beallitasok} táblázatban. A jobb olvashatóság érdekében csak körülírom a beállításokat és nem a programban található elnevezést használom.
		
		% Table generated by Excel2LaTeX from sheet 'MATLAB táblázat'
		\begin{table}[htbp]
		  \centering
		  \caption{N-test szimulátor MATLAB változatának konfigurációs lehetõségei}
			\begin{tabular}{|l|p{8cm}|}
			\hline
			Beállítás & Leírás \\
			\hline \hline
			Algoritmus típus & A változóba elõre definiált sztringek írásával változtatható az alkalmazott algoritmus. A program jelenleg a direkt módszert és az elágazásos direkt módszert valósítja csak meg. \\
			\hline
			\multirow{2}[2]{*}{KDE megoldó típusa és beállításai} & Lehetõség van beépített, vagy saját (ez lényegében az integrátor) használatára. \\
				  & Beállításai csak a beépítettnek vannak. \\
			\hline
			Szimuláció célja és ciklusszám & Választhatunk egyszeri lefutás illetve, többszöri futtatás között, amivel elsõsorban teljesítménymérést hajthatunk végre. \\
			\hline
			Test paraméterek, randomizáció & A testeket inicializáló szkript számára ad információkat. Szintén itt állítható be a testek száma. \\
			\hline
			Szimulációs idõ & A szimuláció kezdetét, végét valamit a lépésközt tartalmazzák napokban mérve. \\
			\hline
			$\varepsilon$ (softening factor) & Csillagászati egységben kifejezett érték, az erõszámítás során használja fel a program. \\
			\hline
			Naplózás & Lehetõség van naplózás bekapcsolására, mely formázva kiírja a szimulációs paramétereket, futási eredményeket egy szöveges fájlba, dátummal és idõvel címkézve. \\
			\hline
			\end{tabular}%
		  \label{tab:mat_beallitasok}%
		\end{table}%

		A \verb+Main+ szkript felelõs a többi megírt függvény meghívásáért. A beállítások után elõször az inicializációs szkript fut le, mely a testeket elõkészíti. Ezt követõen kerül meghívásra maga a szimulációs algoritmus (integrátor), mely elvégzi az erõk kiszámítását, elmenti a kapott pozícióértékeket a késõbbi kijelzésre és méri a futási teljesítményt.

		A szimuláció végeztével történik meg a naplózás (amennyiben be van kapcsolva ez az opció), valamint a futási eredmények kijelzése (teljes futási idõ, átlagos futási idõ, kiszámolt erõk száma másodpercenként). A kirajzoltatás a beépített \verb+plot3()+ függvények segítségével történik.

	%----------------------------------------------------------------------------
	\subsection{Inicializáció}
	%----------------------------------------------------------------------------
		A beállítások megadása után a rendszert inicializáló szkript hívódik meg, melynek feladata a testek létrehozása és a szükséges kezdeti feltételek generálása a beállítások alapján. A test paraméterekben megadhatók speciális sztringek mellyel elõre programozott szimulációk, speciális esetek idézhetõek elõ. Számos ötletem támadt megvalósítás és tesztelés közben, ám mindössze kettõt valósítottam meg.

		Az egyik ilyen speciális eset a SEL (Sun-Earth-Luna), mely egy $N = 3$ testbõl álló rendszert reprezentál, s kezdeti feltételei közel azonosak a Nap, Föld és Hold alkotta hármas tulajdonságaival (tömeg, egymástól való távolság, sebesség). A \figref{SEL2} ennek futására láthatunk példát. Összesen 365 napot szimulál a program 1 napos lépésközt alkalmazva, a tengelyeken látható értékek $AU$-ban értendõk. A Nap piros, a Föld zöld, a Hold pedig kék színnel van feltüntetve. A képeken a továbbiakban a vonal jelzi a megtett utat, a pont vagy kereszt pedig az éppen aktuális pozíciót jelöli a térben.

		\begin{figure}[!ht]
		\centering
		\includegraphics[width=150mm, keepaspectratio]{figures/MATLAB/SEL2.png}
		\caption{Nap-Föld-Hold hármas szimulációja}
		\label{fig:SEL2}
		\end{figure}
		
		A képen szépen látszódik, ahogy a Föld kering a nap körül, s a Hold által okozott tömegvonzás miatt apró kitérések láthatók a zöld vonalon. A Nap mozgása elhanyagolható, és csak erõsen belenagyítva látszódik MATLAB-ban. Érdekes, hogy a Hold összesen 13 periódust tesz meg a Föld körül (27,3 nap a keringési ciklusideje, ami 13 ciklust jelent 1 év alatt). Jelzem, hogy ez egy durva közelítése a rendszernek és a beállítások módosításával, pontosság állításával nagyban változtatható a pálya alakja. Sikerült olyan szimulációt is futtatni, melyben a Hold pár év szimulációja után ,,belecsapódott'' a Földbe, így mindig érdemes végiggondolni mennyire helyes a kapott eredmény.

		A másik megvalósított inicializáció során a beállításokban megadott \verb+seed+ alapján egy elõre definiált intervallumon belül, véletlenszerû értékekkel ruházza fel a testeket. Az értékeket úgy határoztam, hogy közel reálisak legyenek, valamint a szimuláció során látványos eredményt produkáljanak.
		
		A \figref{16_twister} ábrán egy véletlenszerû kezdeti feltételekkel ellátott, $N = 16$ testbõl álló rendszer szimulációja látható. A választott idõtartam 100~000 nap, a lépésköz 100 nap.
		
		\begin{figure}[!ht]
		\centering
		\includegraphics[width=150mm, keepaspectratio]{figures/MATLAB/16_twister.png}
		\caption{N=16 testes szimuláció}
		\label{fig:16_twister}
		\end{figure}

		Ennek a szkriptnek a továbbfejlesztési lehetõségei közé tartozik több speciális eset megvalósítása.
		
	%----------------------------------------------------------------------------
	\subsection{Integrálás és az erõ számítása}
	%----------------------------------------------------------------------------
		Ebben a csoportban több fájl (függvény) is megtalálható, melyeket együtt érdemes tárgyalni. Minden algoritmushoz két fájl tartozik. Az egyik egy kiegészítõ fájl, ami az idõmérést és egyéb, kiegészítõ teendõket lát el, valamint az ezekbõl a függvényekbõl meghívásra kerülõ, algoritmust megvalósító integrátorok, amik az erõ kiszámítását végzik a megadott idõintervallumon belül, a megadott beállítások szerint.

		Összesen három ilyen fájlpárt valósítottam meg, melyek a Main szkriptbõl meghívhatók:
		\begin{enumerate}
			\item Direkt módszer, saját integrátorral
			\item Direkt módszer, beépített KDE megoldó segítségével
			\item Közelített direkt módszer, saját integrátorral
		\end{enumerate}

		A beépített KDE megoldó lecserélhetõ. Jelenleg az \verb+ode45+ nevût használja, ami egy Runge-Kutta módszert megvalósító, változó lépésközû algoritmuson alapszik. A lépésköz mindig a jelváltozás (esetünkben a pozíció, sebesség) mértéke adja meg. Minél intenzívebb a pályaváltozás annál sûrûbb a kiértékelések száma, ezzel segíti optimális sebesség-pontosság arány elérését.
		
	%----------------------------------------------------------------------------
	\subsection{Eredmények}
	%----------------------------------------------------------------------------
		Egy példa szimuláción keresztül mutatom be a futási eredményeket és az eredménybeli eltéréseket. A releváns beállításokat \tabref{mat_eredmenybellitasok}, a futási idõket pedig a \tabref{mat_futasieredmenyek} táblázat tartalmazza.
		
		% Table generated by Excel2LaTeX from sheet 'MATLAB eredmények'
		\begin{table}[htbp]
		  \centering
		  \caption{Futtatási beállítások}
			\begin{tabular}{|l|p{8cm}|}
			\hline
			Beállítás & Érték \\
			\hline \hline
			Testek száma & 32 \\
			\hline
			Testek tulajdonságai & Véletlenszerû (mivel a \verb+Seed+ mindig azonos, ezért a generált kezdeti értékek is azonosak) \\
			\hline
			Szimuláció idõtartama & 20000 \\
			\hline
			Szimulációs lépésköz & 100 \\
			\hline
			$\varepsilon$ (softening factor) & 1 \\
			\hline
			Seed  & 10 \\
			\hline
			\end{tabular}%
		  \label{tab:mat_eredmenybellitasok}%
		\end{table}%

		% Table generated by Excel2LaTeX from sheet 'MATLAB eredmények'
		\begin{table}[htbp]
		  \centering
		  \caption{Program futási idõk}
			\begin{tabular}{|l|l|l|}
			\hline
			Módszer & Megoldó & Átlagos futási idõ [sec] \\
			\hline \hline
			Direkt & Saját integrátor & 0,7013 \\
			\hline
			Direkt & \verb+ode45+ KDE megoldó & 12,959 \\
			\hline
			Közelített direkt & Saját integrátor & 0,2853 \\
			\hline
			\end{tabular}%
		  \label{tab:mat_futasieredmenyek}%
		\end{table}%

		A szemléletes grafikus bemutatás miatt választottam a testszámot 32-re. A teljes keletkezett ábrák a függelékben találhatók (\figref{32_direct}, \figref{32_ODE}, \figref{32_selective}).

		A futási sebességbõl látszik, hogy a saját integrátor és a KDE megoldó összehasonlítása nehéz feladat, mivel a KDE implementációja számomra ismeretlen, és a beállított hibaparaméterek, ami alapján dolgozik, nagyban befolyásolják a végeredményt. Elõfordult olyan helyzet, amikor lényegesen gyorsabb volt, mint a saját megvalósításom, de elõfordult olyan is, hogy szingularitás miatt hibaüzenettel fejezte be a futást. A közelítõ módszer a várt módon felgyorsította a futást, jelen esetben a szorzó közel 2,5.

		A függelékben lévõ ábrákon láthatók eltérések, melyek az apró akkumulálódott hibáknak és az eltérõ implementációnak tudható be. Ez egy példa arra vonatkozóan, hogy a különbözõ N-test szimulációt megvalósító alkalmazások korrekt összehasonlítása mennyire nehézkes feladat a megvalósítás ismeretének hiányában.
		
	%----------------------------------------------------------------------------
	\subsection{Konklúzió}
	%----------------------------------------------------------------------------
		Számos, különbözõ kezdeti feltétellel elvégzett szimuláció után néhány fontos dolgot megtapasztaltam.

		Elõször is a \emph{kezdeti feltételek} nagyon fontosak. Ha egy test sebességét, egy adott távolságnál megfelelõen állítom be elérhetõek stabil keringési pályák (például kettõ test esetén). Ha azonban kisebbre veszem, akkor ütköznek. Ha nagyobbra, akkor a köztük kialakuló erõk hatása elenyészõ lesz és távolodni fognak egymástól végig. Lásd \sectref{nbody_szimhibak} alfejezet.

		Másik fontos probléma a \emph{numerikus szingularitás}. Ha a két test nagyon megközelíti egymást és végsõ esetben egymáson lesznek, a kialakuló erõ közel végtelen nagy lehet, ami jelen esetben azt eredményezte, hogy kilõtték egymást ellentétes irányban.

		Harmadik probléma az \emph{integrációs idõ problémája}. Ha túl nagy lépésközt választok az egyenletek kiszámítása között, akkor nagyon pontatlan eredményt kapok ugyanazon kezdeti feltételekre, esetekben felismerhetetlenül nagy eltérésekkel.
